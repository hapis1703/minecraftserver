#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

# ===== COLORS =====
GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

clear
echo -e "${CYAN}======================================"
echo "   Bedrock Dedicated Server Installer"
echo -e "======================================${RESET}"

# ===== DEPENDENCIES =====
sudo apt update -qq >/dev/null
sudo apt install -y -qq curl wget unzip grep sed >/dev/null

mkdir -p server
cd server

# ===== FETCH VERSION LIST =====
echo -e "${CYAN}> Fetching Bedrock server versions...${RESET}"

curl -s https://minecraft.wiki/w/Bedrock_Dedicated_Server \
| grep -o 'https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-[^"]*\.zip' \
| sort -Vr \
| uniq > versions.txt

if [[ ! -s versions.txt ]]; then
    echo -e "${RED}> Failed to fetch version list${RESET}"
    exit 1
fi

mapfile -t VERSIONS < versions.txt
TOTAL=${#VERSIONS[@]}

# ===== SHOW MENU =====
echo ""
echo -e "${YELLOW}Available Versions:${RESET}"
echo ""

for i in "${!VERSIONS[@]}"; do
    VERSION=$(echo "${VERSIONS[$i]}" | sed -E 's/.*bedrock-server-(.*)\.zip/\1/')
    printf " [%02d] %s\n" "$((i+1))" "$VERSION"
done

echo ""
read -rp "Select version [1-${TOTAL}]: " CHOICE

if ! [[ "$CHOICE" =~ ^[0-9]+$ ]] || (( CHOICE < 1 || CHOICE > TOTAL )); then
    echo -e "${RED}> Invalid selection${RESET}"
    exit 1
fi

DOWNLOAD_URL="${VERSIONS[$((CHOICE-1))]}"
VERSION_SELECTED=$(echo "$DOWNLOAD_URL" | sed -E 's/.*bedrock-server-(.*)\.zip/\1/')
FILE_NAME="bedrock-server-${VERSION_SELECTED}.zip"

echo ""
echo -e "${GREEN}> Selected version: ${VERSION_SELECTED}${RESET}"
echo -e "${CYAN}> Downloading server...${RESET}"

# ===== BACKUP CONFIG =====
for f in server.properties permissions.json whitelist.json; do
    [[ -f $f ]] && cp "$f" "$f.bak"
done

# ===== DOWNLOAD & EXTRACT =====
wget "$DOWNLOAD_URL"
unzip -oq "$FILE_NAME"
rm -f "$FILE_NAME"

# ===== RESTORE CONFIG =====
for f in server.properties permissions.json whitelist.json; do
    [[ -f $f.bak ]] && mv "$f.bak" "$f"
done

chmod +x bedrock_server

echo ""
echo -e "${GREEN}âœ” Bedrock Server ${VERSION_SELECTED} installed successfully${RESET}"
echo -e "${CYAN}> Run ./start to launch the server${RESET}"
echo ""
