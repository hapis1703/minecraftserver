#!/bin/bash
set -e

sudo apt update -qq >/dev/null 2>&1
sudo apt install -y -qq screen wget unzip curl >/dev/null 2>&1

mkdir -p server
cd server

echo ""
echo "======================================"
echo "   Bedrock Dedicated Server Installer"
echo "======================================"
echo ""

# ===== FETCH VERSION LIST =====
echo "> Fetching available Bedrock versions..."

curl -s https://minecraft.wiki/w/Bedrock_Dedicated_Server \
| grep -o 'https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-[0-9\.]*\.zip' \
| grep -v -i preview \
| sort -Vr \
| uniq > versions.txt

TOTAL=$(wc -l < versions.txt)

if [[ "$TOTAL" -eq 0 ]]; then
    echo "❌ Failed to fetch versions"
    exit 1
fi

echo ""
echo "Available Versions:"
echo "-------------------"

nl -w2 -s". " versions.txt | sed 's#.*/bedrock-server-##' | sed 's/.zip//'

echo ""
read -rp "Select version [1-$TOTAL]: " CHOICE

if ! [[ "$CHOICE" =~ ^[0-9]+$ ]] || (( CHOICE < 1 || CHOICE > TOTAL )); then
    echo "❌ Invalid selection"
    exit 1
fi

DOWNLOAD_URL=$(sed -n "${CHOICE}p" versions.txt)
DOWNLOAD_FILE=$(basename "$DOWNLOAD_URL")

echo ""
echo "> Selected version: ${DOWNLOAD_FILE%.zip}"
echo "> Downloading server..."

# ===== BACKUP CONFIGS =====
for f in server.properties permissions.json whitelist.json; do
    [[ -f "$f" ]] && cp "$f" "$f.bak"
done

# ===== DOWNLOAD & INSTALL =====
wget -q "$DOWNLOAD_URL" -O "$DOWNLOAD_FILE"

echo "> Extracting..."
unzip -oq "$DOWNLOAD_FILE"
rm "$DOWNLOAD_FILE"

# ===== RESTORE CONFIGS =====
for f in server.properties permissions.json whitelist.json; do
    [[ -f "$f.bak" ]] && mv "$f.bak" "$f"
done

chmod +x bedrock_server
rm -f versions.txt

echo ""
echo "✅ Bedrock Server Installed Successfully!"
echo ""
echo "> Run ./start to launch the server"
echo ""
