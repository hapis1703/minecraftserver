#!/bin/bash

set -e
export DEBIAN_FRONTEND=noninteractive

# ===== COLORS =====
GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

clear
echo -e "${CYAN}"
echo "======================================"
echo "   Minecraft Bedrock Server Installer"
echo "======================================"
echo -e "${RESET}"

# ===== SYSTEM UPDATE =====
echo -e "${CYAN}> Updating system...${RESET}"
sudo apt update -qq
sudo apt upgrade -y -qq

echo -e "${CYAN}> Installing dependencies...${RESET}"
sudo apt install -y -qq screen neofetch wget unzip zip curl gnupg

# ===== SETUP DIRECTORY =====
echo -e "${CYAN}> Preparing server directory...${RESET}"
mkdir -p server
cd server

# ===== CONFIG =====
BEDROCK_VERSION="latest"
LD_LIBRARY_PATH=.
SERVERNAME="Bedrock Dedicated Server"
GAMEMODE="survival"
DIFFICULTY="easy"
CHEATS=false

RANDVERSION=$((1 + RANDOM % 4000))

# ===== DOWNLOAD =====
if [[ -z "$BEDROCK_VERSION" || "$BEDROCK_VERSION" == "latest" ]]; then
    echo -e "${GREEN}> Downloading latest Bedrock server...${RESET}"
    curl -fsSL \
        -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/90.0.$RANDVERSION.212" \
        -H "Accept-Language: en" \
        -o versions.html.gz \
        https://www.minecraft.net/en-us/download/server/bedrock

    DOWNLOAD_URL=$(zgrep -o 'https://www.minecraft.net/bedrockdedicatedserver/bin-linux/[^"]*' versions.html.gz)
else
    echo -e "${GREEN}> Downloading Bedrock $BEDROCK_VERSION...${RESET}"
    DOWNLOAD_URL="https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-$BEDROCK_VERSION.zip"
fi

DOWNLOAD_FILE=$(basename "$DOWNLOAD_URL")

# ===== BACKUP CONFIG =====
echo -e "${CYAN}> Backing up config files...${RESET}"
rm -f *.bak versions.html.gz
cp -f server.properties server.properties.bak 2>/dev/null || true
cp -f permissions.json permissions.json.bak 2>/dev/null || true
cp -f whitelist.json whitelist.json.bak 2>/dev/null || true

# ===== INSTALL =====
echo -e "${CYAN}> Downloading server files...${RESET}"
curl -fsSL -o "$DOWNLOAD_FILE" "$DOWNLOAD_URL"

echo -e "${CYAN}> Extracting files...${RESET}"
unzip -oq "$DOWNLOAD_FILE"

echo -e "${CYAN}> Cleaning up...${RESET}"
rm -f "$DOWNLOAD_FILE"

# ===== RESTORE CONFIG =====
echo -e "${CYAN}> Restoring config files...${RESET}"
cp -f server.properties.bak server.properties 2>/dev/null || true
cp -f permissions.json.bak permissions.json 2>/dev/null || true
cp -f whitelist.json.bak whitelist.json 2>/dev/null || true

chmod +x bedrock_server

echo -e "${GREEN}> Bedrock Server installation completed!${RESET}"

# ===== PLAYIT.GG =====
echo ""
echo -e "${CYAN}> Installing Playit.gg...${RESET}"
cd ..

curl -fsSL https://playit-cloud.github.io/ppa/key.gpg \
    | gpg --dearmor \
    | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null

echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" \
    | sudo tee /etc/apt/sources.list.d/playit-cloud.list >/dev/null

sudo apt update -qq
sudo apt install -y -qq playit

# ===== DONE =====
echo ""
echo -e "${GREEN}âœ” Installation completed successfully!${RESET}"
echo -e "${CYAN}Use ./start to run the server${RESET}"
echo ""
