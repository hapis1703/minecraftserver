#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RESET="\e[0m"

MEM_GB=$(awk '/MemTotal/ {printf "%.0f", $2/1024/1024}' /proc/meminfo)

# ===== DEPENDENCIES =====
if ! command -v screen &>/dev/null; then
    sudo apt update -qq
    sudo apt install -y -qq screen
fi

# ===== PLAYIT =====
if ! command -v playit &>/dev/null; then
    curl -fsSL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
    echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" \
        | sudo tee /etc/apt/sources.list.d/playit-cloud.list >/dev/null
    sudo apt update -qq
    sudo apt install -y -qq playit
fi

if [[ ! -f eula.txt ]]; then
    echo "eula=true" > eula.txt
fi

# ===== SERVER =====
if [[ -f bedrock_server ]]; then
    chmod +x bedrock_server
    screen -S server -d -m ./bedrock_server
else
    echo -e "${CYAN}> Installing SDKMAN...${RESET}"
    curl -s https://get.sdkman.io | bash >/dev/null
    source "$HOME/.sdkman/bin/sdkman-init.sh"
    echo ""
    echo -e "${CYAN}Select Java Version:${RESET}"
    echo ""
    echo -e "${YELLOW}[1] JDK 21  ${RESET}- Minecraft 1.20.6+"
    echo -e "${YELLOW}[2] JDK 17  ${RESET}- Minecraft 1.18 – 1.20.5"
    echo -e "${YELLOW}[3] JDK 8   ${RESET}- Minecraft 1.16.5 & below"
    echo ""

    read -rp "Select JDK [1-3]: " JDK_CHOICE

    case "$JDK_CHOICE" in
        1)
            JAVA_VERSION="21.0.2-open"
            ;;
        2)
            JAVA_VERSION="17.0.18-tem"
            ;;
        3)
            JAVA_VERSION="8.0.472-tem"
            ;;
        *)
            echo -e "${RED}> Invalid choice, using JDK 21 (default)${RESET}"
            JAVA_VERSION="21.0.2-open"
            ;;
    esac
    echo -e "${CYAN}> Installing Java ${JAVA_VERSION}...${RESET}"
    sdk install java "$JAVA_VERSION"
    sdk default java "$JAVA_VERSION"
    screen -S server -d -m \
    java -Xms${MEM_GB}G -Xmx${MEM_GB}G -jar server.jar nogui
fi

if [[ -f geyser/geyser.jar ]]; then
    (cd geyser && screen -S geyser -d -m \
    java -Xms${MEM_GB}G -Xmx${MEM_GB}G -jar geyser.jar nogui)
fi

screen -S playit -d -m playit

# ===== AFK =====
screen -S afk -d -m "$HOME/.local/bin/bpytop"

# ===== INFO =====
echo -e "${GREEN}✔ Server started${RESET}"
echo ""
echo -e "${CYAN}Web Console:${RESET}"
echo " Server  → screen -r server"
echo " Geyser  → screen -r geyser"
echo " Playit  → screen -r playit"
echo ""
echo -e "${YELLOW}Stop server: ./stop${RESET}"

# ===== CHECK =====
bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/check)