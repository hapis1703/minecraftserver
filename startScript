#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RESET="\e[0m"

MEM_GB=$(awk '/MemTotal/ {printf "%.0f", $2/1024/1024}' /proc/meminfo)

# ===== DEPENDENCIES =====
if ! command -v ttyd &>/dev/null; then
    sudo apt update -qq
    sudo apt install -y -qq screen ttyd curl gnupg python3-pip
fi

# ===== PLAYIT =====
if ! command -v playit &>/dev/null; then
    curl -fsSL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
    echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" \
        | sudo tee /etc/apt/sources.list.d/playit-cloud.list >/dev/null
    sudo apt update -qq
    sudo apt install -y -qq playit
fi

if [[ ! -f eula.txt ]]; then
    echo "eula=true" > eula.txt
fi

# ===== SERVER =====
if [[ -f bedrock_server ]]; then
    chmod +x bedrock_server
    screen -S server -d -m ./bedrock_server
else
    screen -S server -d -m \
    java -Xms${MEM_GB}G -Xmx${MEM_GB}G -jar server.jar nogui
fi

if [[ -f geyser/geyser.jar ]]; then
    (cd geyser && screen -S geyser -d -m \
    java -Xms${MEM_GB}G -Xmx${MEM_GB}G -jar geyser.jar nogui)
fi

screen -S playit -d -m playit

# ===== AFK =====
screen -S afk -d -m "$HOME/.local/bin/bpytop"

# ===== WEB CONSOLE =====
screen -S web-server -d -m \
ttyd -p 7681 bash -c "while true; do screen -r server; sleep 1; done"

if screen -list | grep -q geyser; then
screen -S web-geyser -d -m \
ttyd -p 7682 bash -c "while true; do screen -r geyser; sleep 1; done"
fi

screen -S web-playit -d -m \
ttyd -p 7683 bash -c "while true; do screen -r playit; sleep 1; done"

# ===== INFO =====
echo -e "${GREEN}✔ Server started${RESET}"
echo ""
echo -e "${CYAN}Web Console:${RESET}"
echo " Server  → http://<VM-IP>:7681"
echo " Geyser  → http://<VM-IP>:7682"
echo " Playit  → http://<VM-IP>:7683"
echo ""
echo -e "${YELLOW}Stop server: ./stop${RESET}"
