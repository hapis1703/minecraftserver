#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

clear
echo -e "${CYAN}"
echo "======================================"
echo "   Minecraft Server Installer"
echo "======================================"
echo -e "${RESET}"

echo -e "${YELLOW}[1] Java Server"
echo "[2] Bedrock Server${RESET}"
echo ""
read -rp "Select Server Type [1-2]: " SERVER_TYPE

echo -e "${CYAN}> Updating system...${RESET}"
sudo apt update -qq
sudo apt upgrade -y -qq

echo -e "${CYAN}> Installing dependencies...${RESET}"
sudo apt install -y -qq curl wget dos2unix python3-pip screen ttyd

# ===== SDKMAN & JAVA =====
echo -e "${CYAN}> Installing SDKMAN & Java 21...${RESET}"
curl -s https://get.sdkman.io | bash >/dev/null
source "$HOME/.sdkman/bin/sdkman-init.sh"
sdk install java 21.0.2-open >/dev/null
sdk default java 21.0.2-open >/dev/null

# ===== SERVER INSTALL =====
if [[ "$SERVER_TYPE" == "1" ]]; then
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installJava)

    read -rp "Install Geyser (Cross-play)? [Y/n]: " GEYSER
    GEYSER=${GEYSER:-Y}
    [[ "$GEYSER" =~ ^[Yy]$ ]] && \
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installGeyser)

elif [[ "$SERVER_TYPE" == "2" ]]; then
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installBedrock)
else
    echo -e "${RED}> Invalid selection${RESET}"
    exit 1
fi

# ===== START / STOP =====
cd server
wget -q https://github.com/hapis1703/minecraftserver/raw/main/start -O start
wget -q https://github.com/hapis1703/minecraftserver/raw/main/stop -O stop
chmod +x start stop
dos2unix start stop >/dev/null

# ===== AFK TOOL =====
pip3 install -q bpytop

echo -e "${GREEN}âœ” Installation completed${RESET}"
echo -e "${CYAN}Use ./start to run the server${RESET}"
