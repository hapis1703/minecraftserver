#!/bin/bash

set -e
export DEBIAN_FRONTEND=noninteractive

# ===== COLORS =====
GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

clear

echo -e "${CYAN}"
echo "======================================"
echo "   Minecraft Server Installer"
echo "======================================"
echo -e "${RESET}"

echo -e "${YELLOW}[1] Java Server"
echo "[2] Bedrock Server${RESET}"
echo ""
read -rp "Select Server Type [1-2]: " SERVER_TYPE

echo ""
echo -e "${CYAN}> Updating system...${RESET}"
sudo apt update -qq
sudo apt upgrade -y -qq

echo -e "${CYAN}> Installing dependencies...${RESET}"
sudo apt install -y -qq curl wget dos2unix python3-pip

# ===== SDKMAN & JAVA =====
echo -e "${CYAN}> Installing SDKMAN...${RESET}"
curl -s https://get.sdkman.io | bash >/dev/null
source "$HOME/.sdkman/bin/sdkman-init.sh"

echo -e "${CYAN}> Installing Java 21...${RESET}"
sdk install java 21.0.2-open >/dev/null
sdk default java 21.0.2-open >/dev/null

# ===== SERVER INSTALL =====
if [[ "$SERVER_TYPE" == "1" ]]; then
    echo -e "${GREEN}> Installing Java Server...${RESET}"
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installJava)

    echo ""
    read -rp "Install Geyser (Cross-play)? [Y/n]: " GEYSER
    GEYSER=${GEYSER:-Y}

    if [[ "$GEYSER" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}> Installing Geyser...${RESET}"
        bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installGeyser)
    fi

elif [[ "$SERVER_TYPE" == "2" ]]; then
    echo -e "${GREEN}> Installing Bedrock Server...${RESET}"
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/installBedrock)

else
    echo -e "${RED}> Invalid selection. Restarting installer...${RESET}"
    bash <(curl -s https://raw.githubusercontent.com/hapis1703/minecraftserver/main/install)
    exit 1
fi

# ===== START / STOP SCRIPT =====
cd server

echo -e "${CYAN}> Installing start/stop scripts...${RESET}"
wget -q https://github.com/hapis1703/minecraftserver/raw/main/start -O start
wget -q https://github.com/hapis1703/minecraftserver/raw/main/stop -O stop
chmod +x start stop
dos2unix start stop >/dev/null

# ===== AFK TOOL =====
echo -e "${CYAN}> Installing monitoring tools...${RESET}"
pip3 install -q bpytop

echo ""
echo -e "${GREEN}âœ” Installation completed successfully!${RESET}"
echo -e "${CYAN}Use ./start to run the server${RESET}"
echo ""
